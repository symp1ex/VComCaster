# VComCaster

## Описание
Утилита призванна решить проблему связи устройств, использующих драйвер usb virtual com (например 2D сканер штрих-кодов) и тяжёлого ПО (например кассовое ПО).

Сканер, в приведённом примере, может отваливаться и после его переподключения, чтобы заново занять зависший порт, приходится перезапускать использующее его ПО. Решает проблему зависания COM-портов и смены номеров портов при отключении/подключении USB-устройств. Утилита автоматически переподключается к устройству при смене порта и транслирует данные через постоянный виртуальный COM-порт. Кассовое ПО слушает вирутальный com-порт, который постоянен, не меняется и не зависает, что избавляет от необходимости перезапуска ПО.

Функционал проверялся на сканерах штрих-кода, работающих через драйвер USB Virtual COM. Технически должно работать с любым USB-устройством, использующим этот драйвер.

## Установка и настройка

### Требования
- Windows 7/8/10/11 (На `Win7` и `Embedded` может потребоваться установка обновления безопасности `KB3063858`)
  
- Python 3.8.10+ 32-bit (не требуется, если утилита запускается из исполняемого `.exe-файла`)

### Начальная настройка
1. Создать пару виртуальных COM-портов через com0com (при установке снять галку с "CNCA0 <-> CNCB0")
2. В конфигурации ПО, работающего с устройством, указать первый виртуальный порт вместо физического порта сканера
3. Второй виртуальный порт указать в `config.ini` утилиты в параметре `output_port`
4. Физический порт устройства указать в том же конфиге в параметре `input_port`
5. Добавить папку с утилитой в исключения антивируса и ярлык в автозагрузку
6. Для автоопределения устройства при смене порта, указать его `device_id` из свойств в диспетчере устройств Windows (Для отключения функции, просто оставьте значение пустым.)
7. Убедиться что `autostart_listing = 1` в конфиге. Если настраиваем через интерфейс, перед сохранением проверить что активирована галочка "Подключение к устройству при запуске".
8. Сохраняем конфиг и запускаем. (если уже запущена: щёлкнуть правой кнопкой по иконке в трее, нажать "стоп" и нажать "переподключиться")

После изменении настроек в конфиге при запущенном приложении, всегда стоит нажать на "переподключиться".

### Пример настройки утилиты с <b>iikoFront</b>

![README](https://github.com/user-attachments/assets/05d50390-bec1-460e-9390-7d052a3a4bb2)

  
## Конфигурация

<details>
<summary><b>config.ini</b></summary>

```ini
[app]
autostart_listing = 1
autoreconnect = 1
logs-autoclear-days = 3

[device]
device_id = ID устройства из диспетчера устройств
input_port = COM4
output_port = COM10
port_baudrate = 115200
cr = 0
lf = 0

[service]
timeout_autoreconnect = 5
timeout_reconnect = 5
timeout_clearcash = 1.5
```
Параметры приложения:
- `autostart_listing`: автоподключение при запуске
- `autoreconnect`: автоматическое переподключение
- `logs-autoclear-days`: дней хранения логов

Параметры устройства:
- `device_id`: ID устройства для автоопределения порта
- `input_port`: физический COM-порт устройства  
- `output_port`: виртуальный COM-порт для связи с ПО
- `port_baudrate`: скорость порта
- `cr`, `lf`: добавление CR/LF к передаваемым данным

Сервсиные параметры:
- `timeout_autoreconnect`: интервал автопереподключения (сек)
- `timeout_reconnect`: задержка ручного переподключения (сек) 
- `timeout_clearcash`: время жизни данных в буфере (сек)

</details>

## Примечания

<details>
<summary>Поиск устройства по <b>ID-оборудования</b></summary>

При первом запуске утилита не сможет автоматически найти устройство по `device_id`, пока не будет нажата кнопка "переподключиться". Когда включен `autoreconnect`, утилита сделает это автоматически.

Если не используется `autoreconnect`, порт устройства лучше указывать вручную.

Поиск идёт по "Путь к экземпляру устройства" из свойств сканера в диспетчере устройств Винды, но не по полному значению, а по маске. От значения нужно откинуть последние 5-7 символов (т.к. они могут меняться, если поменялся номер порта).

Параметр `amount_rm_char_id = 0` определяет сколько символов отбрасывать от `device_id` при поиске. При значении 0 нужно вручную убрать последние 5-7 символов из пути к устройству.

Параметр `amount_rm_char_id = 0` определяет сколько символов откидывать от `device_id` перед поиском. Можно оставить `0`, но тогда придётся вручную убрать лишние 5-7 символов из пути к устройству. Я не знаю от чего зависит, но обычно при переключении устройства между соседними usb-портами в `Путь к экземпляру устройства"`меняются только последние несколько символов и всё отрабатывает как надо. 

Если переключить устройство, например, из передней панели ПК в заднюю, то поменяется вся часть пути после `ИД обородувания` и сканер уже находиться не будет. Если такое происходит, то можно указывать именно `ИД обородувания` (он идентичен первой половине `Путь к экземпляру устройства`) из диспетчера устройств, только убедитесь что нет других устройств использующих тот же драйвер (тогда `ИД обородувания` будет совпадать) и не забудьте выставить параметр `amount_rm_char_id` строго на 0. 

</details>

<details>
<summary>Особенности работы с <b>com0com</b></summary>

При установке com0com нужно:
1. Поставить галочку напротив "COM# <-> COM#"
2. Снять напротив "CNCA0 <-> CNCB0"
3. Проверить номера созданных портов в диспетчере устройств

В случае ошибки подписи драйверов, можно использовать один из вариантов:
1. Отключить SecureBoot в BIOS
2. Загрузить систему без проверки подписи драйверов
3. Использовать com0com 2.2.2.0 с ручным переименованием портов
4. Использовать другую утилиту для создание виртуальных com-портов

</details>
